<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase</title>
  </head>
  <body>
    <section>
      <form id="text-form">
        <input type="text" name="content" placeholder="ë‚´ìš© ì…ë ¥" required />
        <button type="submit">í…ìŠ¤íŠ¸ ë“±ë¡</button>
      </form>
    </section>
    <section>
      <form id="file-form">
        <input type="file" name="file" accept="image/*" required />
        <button type="submit">íŒŒì¼ ë“±ë¡</button>
      </form>
    </section>
    <section>
      <h3>ë°ì´í„° ëª©ë¡</h3>
      <ul id="container"></ul>
    </section>
  </body>
  <script>
    const supabaseUrl = "https://zhweceexagwizqhrlqvy.supabase.co";
    const supabaseAnonKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpod2VjZWV4YWd3aXpxaHJscXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyMzY1MzEsImV4cCI6MjA1NDgxMjUzMX0.loxcxx_IFeLbXJWRuXy4-FRMakS0J6ZLYTSe8Ofx8kU";

    const tableName = "MY_TABLE";
    const storageBucket = "uploads";
    const textForm = document.querySelector("#text-form");
    const fileForm = document.querySelector("#file-form");
    const container = document.querySelector("#container");

    // ğŸ“Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (GET ìš”ì²­)
    async function fetchData() {
      const response = await fetch(`${supabaseUrl}/rest/v1/${tableName}`, {
        method: "GET",
        headers: {
          apikey: supabaseAnonKey,
          Authorization: `Bearer ${supabaseAnonKey}`,
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();
      console.log("ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:", data);

      // ğŸ”¥ ë°ì´í„° ëª©ë¡ì„ UIì— í‘œì‹œ
      container.innerHTML = "";
      data.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item.content || "(íŒŒì¼ë§Œ ë“±ë¡ë¨)";
        if (item.file_url) {
          const img = document.createElement("img");
          img.src = item.file_url;
          img.style.maxWidth = "200px";
          li.appendChild(img);
        }
        container.appendChild(li);
      });
    }

    // ğŸ“Œ í…ìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ (POST ìš”ì²­)
    textForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(textForm);
      const content = formData.get("content");

      const response = await fetch(`${supabaseUrl}/rest/v1/${tableName}`, {
        method: "POST",
        headers: {
          apikey: supabaseAnonKey,
          Authorization: `Bearer ${supabaseAnonKey}`,
          "Content-Type": "application/json",
          Prefer: "return=representation",
        },
        body: JSON.stringify({ content }),
      });

      if (response.ok) {
        textForm.reset();
        fetchData();
      } else {
        alert("í…ìŠ¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨");
      }
    });

    // ğŸ“Œ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
    fileForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(fileForm);
      const file = formData.get("file");
      let fileUrl = null;

      if (file && file.size > 0) {
        const fileExt = file.name.split(".").pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const filePath = `${fileName}`;

        const { data, error } = await fetch(
          `${supabaseUrl}/storage/v1/object/${storageBucket}/${filePath}`,
          {
            method: "POST",
            headers: {
              apikey: supabaseAnonKey,
              Authorization: `Bearer ${supabaseAnonKey}`,
              "Content-Type": file.type,
            },
            body: file,
          }
        );

        if (!error) {
          fileUrl = `${supabaseUrl}/storage/v1/object/public/${storageBucket}/${filePath}`;
        }
      }

      if (fileUrl) {
        const response = await fetch(`${supabaseUrl}/rest/v1/${tableName}`, {
          method: "POST",
          headers: {
            apikey: supabaseAnonKey,
            Authorization: `Bearer ${supabaseAnonKey}`,
            "Content-Type": "application/json",
            Prefer: "return=representation",
          },
          body: JSON.stringify({ file_url: fileUrl }),
        });

        if (response.ok) {
          fileForm.reset();
          fetchData();
        } else {
          alert("íŒŒì¼ ì¶”ê°€ ì‹¤íŒ¨");
        }
      }
    });

    // í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    fetchData();
  </script>
</html>
